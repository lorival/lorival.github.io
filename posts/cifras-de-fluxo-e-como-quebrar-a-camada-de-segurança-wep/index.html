<body class="body-blog-post">
    <!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Lorival Smolski Chapuis</title>
        <script data-ad-client="ca-pub-5019351576394165" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-60447750-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-60447750-1');
        </script>

        
        <script>
                (function(h,o,t,j,a,r){
                h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
                h._hjSettings={hjid:1770825,hjsv:6};
                a=o.getElementsByTagName('head')[0];
                r=o.createElement('script');r.async=1;
                r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
                a.appendChild(r);
                })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
        </script>

        <script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=5e981c7368865d0012fff460&product=inline-share-buttons' async='async'></script>
        <script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=5e981c7368865d0012fff460&product=sticky-share-buttons&cms=sop' async='async'></script>
        <script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=5e981c7368865d0012fff460&product=inline-reaction-buttons&cms=sop' async='async'></script>
    <link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/Pe-icon-7-stroke.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/social-icons.css">
<link rel="stylesheet" href="/css/owl.carousel.css">
<link rel="stylesheet" href="/css/owl.theme.css">

<link rel="stylesheet" href="/css/main.css">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png">
<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">

</head>
<body>

<header class="navbar-fixed-top">
    <div class="container">
        <div class="row">

            <div class="col-lg-12">
                <div class="header-top">
                    <div class="header-top-logo">
                        <a href="/" title="Full Stack Hacker"><img src="/images/home/logo.png" alt="Full Stack Hacker"></a>
                    </div>
                    <div class="header-top-text">
                        <p><span class="font-italic">“If knowledge can create problems, it is not through ignorance that we can solve them.”</span> Isaac Asimov</p>
                    </div>
                    <nav class="header-top-nav">
                        <ul>
                            
                            <li><a href="#" class="light-link" title="Menu">
                                <div id="menu-animate-icon" class="header-top-nav-menu-icon">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </a></li>
                        </ul>
                    </nav>
                </div>
            </div>

            <div class="col-lg-12">
                <nav class="header-nav">
                    <ul>
                         
 
    
        <li>
            <a href="/pt/" title="Início">
                <span>Início</span>
            </a>
        </li>
     
 
    
        <li class="dropdown">
            <a href="#" class="dropdown-toggle" title="Artigos">Artigos</a>
            <ul class="dropdown-menu">
                
    
         
    
         
    
         
    
        
            <li class="nav-elipse-green">
                <a href="/categories/security" title="Security">Security</a>
            </li>
         
    
         
    



            </ul>
        </li>
     
 
    
        <li>
            <a href="/inspirations/" title="Inspirações">
                <span>Inspirações</span>
            </a>
        </li>
     
 
    
        <li>
            <a href="/summary/" title="Sumário">
                <span>Sumário</span>
            </a>
        </li>
     
 
    
        <li>
            <a href="/about/" title="Sobre mim">
                <span>Sobre mim</span>
            </a>
        </li>
     


<li style="float: right">
    
</li>
                    </ul>
                </nav>
            </div>
        </div>
  
    </div>
</header>

<nav class="mobile-nav header-nav">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                
            </div>
        </div>
    </div>
</nav>


    <div class="article-nav">
        <ul>
            <li>
                
                <a href="/posts/cifra-de-bloco-e-permuta%C3%A7%C3%B5es-pseudo-aleat%C3%B3rias/" title="Próximo" style="background-color: rgba(243, 243, 243, 0.95);">
                    <i class="pe-7s-angle-right"></i>
                    <div>
                        <p>Próximo</p>
                        <h3>Cifra de bloco e permutações pseudo-aleatórias</h3>
                    </div>
                </a>
                
            </li>
            <li>
                
                <a href="/posts/o-segredo-perfeito-e-a-cifra-one-time-pad-otp/" title="Anterior" style="background-color: rgba(243, 243, 243, 0.95);">
                    <i class="pe-7s-angle-left"></i>
                    <div>
                        <p>Anterior</p>
                        <h3>O segredo perfeito e a cifra One Time Pad (OTP)</h3>
                    </div>
                </a>
                
            </li>
        </ul>
    </div>

    <main>
        <div class="container">
            <section class="articles articles-blog-post">
                <article class="articles-blog-post">
                    <div class="">
                        <div class="row">
                            <div class="col-lg-12 col-xs-12">
                                
     

     

     

    
        <div style="height: 10px;" class="bkg-green"></div>
     

     

                                <div class="articles-header">
                                    <span><i class="pe-7s-clock" style="font-weight: bold"></i> Leia em 9 min &nbsp;</span>
                                    <span><i class="pe-7s-date" style="font-weight: bold"></i> 
    out de 2018
</span>
                                    
                                    
     

     

     

        
        <span class="articles-header-category">
            <a href="/categories/security" class="green" title="Security">Security</a>
        </span>
     

     


                                </div>
                                <div class="articles-content" style="text-align: justify;">
                                    <img src="/posts/2018/10-stream-cipher.jpg" style="width: 100%;height: auto;">
                                    <div class="articles-header" style="margin: 0px;">
                                        
    <span class="articles-header-tag">
        <a href="/tags/wep">WEP</a>
    </span>

    <span class="articles-header-tag">
        <a href="/tags/wifi">WIFI</a>
    </span>

    <span class="articles-header-tag">
        <a href="/tags/algorithm">algorithm</a>
    </span>

    <span class="articles-header-tag">
        <a href="/tags/cipher">cipher</a>
    </span>

    <span class="articles-header-tag">
        <a href="/tags/symetric">symetric</a>
    </span>


                                    </div>
                                    <h1 class="articles-content-blog-post-title"><a href="/personas/" class="light-link">
    <img src="/images/persona/pro.png" title="pro" style="width: 50px; height:auto;">
</a>
 Cifras de fluxo e como quebrar a camada de segurança WEP</h1>
                                    <p><p>Olá mais uma vez hacker, depois de conhecer o One Time Pad (OTP), hoje eu gostaria de falar sobre a aplicação computacional do OTP, chamado de Stream cipher, que basicamente é o OTP mas utilizando números pseudo-aleatórios, ou seja, gerados por uma função matemática seja ela qual for.</p>

<p>Para mais detalhes sobre One Time Pad (OTP), você pode ver meu artigo <a href="/posts/o-segredo-perfeito-e-a-cifra-one-time-pad-otp/">O segredo perfeito e a cifra One Time Pad (OTP)</a>), mas apenas para relembrar o OTP possui <strong>segredo perfeito</strong>, ou seja, não é possível atacar o texto encriptado com o objetivo de saber o texto original se ele for aplicado corretamente, o grande trunfo disto é ter uma chave do mesmo tamanho da mensagem. Além disto a chave do OTP são números verdadeiramente aleatórios.</p>

<p>Bom, já vimos que gerar números aleatórios não são tão simples assim para o computador, quando eu falei sobre <a href="/posts/n%C3%BAmeros-aleat%C3%B3rios-gerados-por-computador-s%C3%A3o-mesmo-aleat%C3%B3rios/">Números aleatórios gerados por computador são mesmo aleatórios?</a>), mas além disto temos detalhes importante:</p>

<ul>
<li>No artigo eu disse que a <strong>seed</strong> de uma função aleatória é como a senha da função, ou seja, mesmo que um algoritmo seja determinístico e você souber exatamente como ele funciona, ainda precisará saber qual foi a seed utilizada nele para gerar os números aleatórios e assim tentar prever o próximo número. Pois bem, no Stream cipher, a chave é mesmo a <strong>seed</strong>, ou seja, um valor pequeno, verdadeiramente aleatório que servirá como input para uma função geradora de número pseudo-aleatórios.</li>
<li>Se a chave de uma Stream cipher é uma <strong>seed</strong>, logo a chave não tem o mesmo tamanho da mensagem e por fim não possui um <strong>segredo perfeito</strong>.</li>
<li>A segurança depende da qualidade do algoritmo que recebe a semente e gera os números pseudo-aleatórios.</li>
</ul>

<p>Por isto o gerador de valores pseudo-aleatórios precisa ser realmente serem bons, e a correta utilização deles também é excencial.</p>

<h3 id="como-funciona-o-ataque-a-redes-wifi-que-utilizam-wep">Como funciona o ataque a redes WIFI que utilizam WEP?</h3>

<hr />

<p>Um exemplo simples de mal aplicação, é na comunicação WIFI utilizando o protocolo 802.11b WEP, é certo que você já sabe que WEP não é um protocolo seguro e que deves usar pelo menos um WPA2 em seu roteador. Na minha época de universidade usávamos (mais pessoas da minha turma) um simples programa que ouvia pacotes de uma determinada rede, que usava o procolo WEP, e em em minutos nos mostrava a senha para acessar. Lembro-me que um amigo, que hoje é um bem sucedido coordenador de desenvolvimento em uma excelente empresa, morava em uma república e, como todo estudante tinha pouca grana, quebrava a WIFI dos vizinhos para poder ter internet na república e poder fazer os trabalhos da universidade.</p>

<p>Na época eu apenas usava um programa que quebrava a senha, mas eu não fazia ideia de como isto funcionava. Hoje vou explicar como esta senha é quebrada e também como o protocolo poderia ter feito para ser um pouco mais seguro.</p>

<p>O protocolo 802.11b possui uma camada de encriptação, esta camada é chamada de WEP. Esta camada possui uma falha simples que eu falei no post sobre OTP citado no início deste post, chamada Two time pad. É esta falha que eu vou explorar aqui.</p>

<ul>
<li>Na WEP temos um cliente (o computador, smartphone, ou o que for) e temos um access point ou um roteador.</li>
<li>Ambos compartilham uma chave compartilhada, chamada de <strong>k</strong>, ou seja, a Stream cipher é um algoritmo simétrico. A chave vai ser usada como <strong>seed</strong> que falamos antes.</li>
<li>Eles enviam pacotes de dados entre si, este pacote é encriptado, o conteúdo antes de ser encriptado é formado por duas partes: a primeira é a mensagem em si, vou chamar de <strong>m</strong> e a segunda é o checksum da mensagem, vou chamar de <strong>cs(m)</strong>.</li>
<li>Para encriptar é necessário um número pseudo-aleatório gerado por um gerador, vou chamar de <strong>PRG</strong>. Para isto precisamos de uma seed, certo? Certo! A seed é formada por duas partes também: a primeira é um valor que vou chamar apenas de <strong>A</strong> e a segunda é a chave em si.</li>
<li>A encriptação já sabemos como é, apenas um XOR do conteúdo a ser enviado com o número aleatório gerado pelo gerador, obtendo assim o texto cifrado que será enviado.</li>
<li>Mas tem algo faltando aqui, o valor <strong>A</strong>, o destino não sabe o que tem neste valor, portanto o pacote de envio é formado também por duas partes: a primeira é o valor <strong>A</strong> e a segunda o texto cifrado, <strong>c</strong>.</li>
</ul>

<p>Considere <strong>||</strong> como representando concatenação, portanto teremos a seguinte expressão: <strong>m || cs(m) XOR PRG(A || k) = c</strong>. O que é enviado é <strong>A || c</strong>.</p>

<p>Este valor <strong>A</strong> é uma string de 24 bits, começa em zero e é um contador que vai incrementando a cada mensagem, apenas isto. Os designers do WEP sabiam que na Stream cipher, o número aleatório gerado só pode ser usado uma única vez (One Time Pad), então pensaram: &ldquo;bom, vamos adicionar um contador que vai mudando a cada pacote enviado e com isto o valor gerado será sempre diferente&rdquo;.</p>

<p>Neste caso quem recebe a mensagem encriptada junto com o valor <strong>A</strong>, consegue usá-lo junto com a chave e decriptografar a mensagem chegando no valor original, veja a expressão: <strong>c XOR PRG(A || k) = m || cs(m)</strong>.</p>

<p>O problema aqui é que uma string de 24 bits pode conter no máximo 2 elevado a 24, ou seja, depois de 16 milhões de pacotes ela precisa ser reiniciada do zero e volta a se repetir, pronto, agora temos o <strong>Two time pad</strong>. Iremos ter duas mensagem encriptadas com o mesmo número gerado aleatóriamente, portanto, como eu expliquei no artigo sobre OTP, esta é uma forma muito simples de obter o valor original da mensagem.</p>

<p>Você pode dizer assim: bom, não vai ser fácil esperar 16 milhões de pacotes para obter uma mensagem encriptada com o mesmo valor, certo? Errado meu amigo hacker! As placas 802.11 podem ser reiniciadas, e ao fazermos isto o contador do pacote volta a ser zero, ou seja, podemos reiniciar a placa e enviar um pacote, reiniciar novamente e enviar outro pacote&hellip; pronto já teremos duas mensagens encriptadas com o mesmo valor&hellip; simples demais não?</p>

<p>Lembre que <strong>c1 XOR c2 = m1 XOR m2</strong>, ou seja, se fizermos o XOR de duas mensagens encriptadas teremos o XOR das duas mensagens originais.</p>

<p>Mas o WEP ainda tem outro problema, não precisariamos nem fazer esta magia toda de reiniciar a placa de rede nem nada disto para descobrir a senha da WIFI, vamos entender melhor isto.</p>

<p>A seed utilizada no gerador de números pseudo-aleatórios é sempre o valor <strong>A</strong>, que como vimos é apenas um contador, concatenado com uma chave compartilhada fixa, ou seja, o seed é tão próximo um do outro, mudam apenas 1 bit de um para o outro, que no fim acabam por ser basicamente sempre o mesmo seed. A função PRG usada no WEP é o <a href="https://en.wikipedia.org/wiki/RC4">RC4</a>, de 1987, este algoritmo não lida bem com seeds tão próximas e acaba gerando números pseudo-aleatórios também próximos entre si.</p>

<p>Em 2001 os criptoanalistas <a href="https://en.wikipedia.org/wiki/Fluhrer,_Mantin_and_Shamir_attack">Fluhrer, Mantin and Shamir</a> mostraram que com um milhão de pacotes transmitidos, utilizando chaves tão próximas assim, era possível descobrir a chave <strong>k</strong>. Com o avanço, hoje sabemos que com apenas 40 mil pacotes já são suficientes para obter a chave :), o que é recuperada em poucos minutos. Apenas por curiosidade, meu tempo de universidade que eu falei era nos anos de 2008, 7 anos depois de terem demonstrado isto ainda existiam muuuuuuitas redes que ainda usavam WEP. Hoje em dia não se encontram mais este tipo de WIFI, assim espero eu :)</p>

<p>Por fim o WEP tem duas falhas, a primeira permite atacar usando Two Time Pad e a segunda é porque utiliza chaves tão relacionadas que é possível deduzir o valor delas ouvindo alguns poucos pacotes.</p>

<h3 id="como-tornar-o-wep-menos-inseguro">Como tornar o WEP menos inseguro?</h3>

<hr />

<p>Primeiro não usar o WEP, claro! Mas vamos pensar primeiro do ponto de vista do Two Time Pad.
Bom, o problema aqui é aquele <strong>A</strong> que permite se repetir, então ele precisa ser removido da equação, remove o <strong>A</strong>. Agora você pode pensar, bom, mas aí não ficou menos seguro, porque os pacotes são pequenos e os números pseudo-aleatórios ficarão pequenos também e podem até se repetir desta forma.
Certo, ao invés de enviar pequenos pacotes independentes, poderia ser enviado uma stream com várias mensagens. Pronto! Você poderia usar sempre a mesma chave como seed e teria valores pseudo-aleatórios gigantes se extendendo por toda stream de mensagens. Em resumo, enviaria lotes de mensagens ao invés de apenas uma de cada vez.</p>

<p>Para o segundo problema, queremos usar chaves realmente diferentes para cada lote de pacotes, certo?
Pois bem, poderia utilizar a chave como seed no gerador, para gerar um número pseudo-aleatório do tamanho do lote de mensagens, depois quebraria estes números pseudo-aleatórios do mesmo tamanho de cada pacote a ser enviado e usava eles como seed do gerador novamente. Em resumo, usaríamos a chave como seed e depois o valor gerado também como seed, a diferença é que como cada pacote terá um tamanho diferente, estas segundas seed também serão diferentes, veja:</p>

<ul>
<li>k = chave compartilhada entre cliente e roteador</li>
<li>m1 = mensagem com 20 bits</li>
<li>m2 = mensagem com 22 bits</li>
<li>m3 = mensagem com 40 bits</li>
<li>lote de pacotes = m1 || m2 || m3 (84 bits)</li>
<li>PRG(k) = número pseudo-aleatório de 84 bits</li>
<li>PRG(primeiros 20 bits do PRG(k)) = números pseudo-aleatórios para m1</li>
<li>PRG(próximos 22 bits do PRG(k)) = números pseudo-aleatórios para m2</li>
<li>PRG(últimos 40 bits do PRG(k)) = números pseudo-aleatórios para m3</li>
</ul>

<p>Sendo assim, usamos os números gerados como seeds para gerar outros números e para decriptar basta fazer o mesmo processo inverso.</p>

<h3 id="projeto-estream-e-novos-geradores-pseudo-aleatórios">Projeto eStream e novos geradores pseudo-aleatórios</h3>

<hr />

<p>o projeto <a href="https://en.wikipedia.org/wiki/ESTREAM">eStream</a>, concluído 2008, deu origem a excelentes geradores pseudo-aleatórios e classificaram alguns tipos diferentes de stream ciphers. Para não me extender muito, vou comentar apenas de um gerador aqui.</p>

<p>A diferença deste gerador está no seed. Em uma stream cipher convencional, que vimos até agora, usamos a chave como seed.
No WEP vimos que era usado a chave concatenada com um contador. Este novo gerador de valores pseudo-aleatórios, o seed é um par de 2 valores:</p>

<ul>
<li>a chave compartilhada (<strong>k</strong>)</li>
<li>um número que nunca pode ser repetido para a mesma chave, ou seja, só pode ser utilizado uma vez (number + once) <a href="https://pt.wikipedia.org/wiki/Nonce#:~:text=Em%20criptografia%2C%20um%20nonce%20%C3%A9,processo%20tamb%C3%A9m%20pode%20usar%20letras.">nounce</a>.</li>
</ul>

<p>Assim, podemos reutilizar a vontade a chave, pois o nounce torna o par (k, nounce) único.</p>

<p>Eu não vou me extender no projeto eStream, quem sabe em outro post eu possa falar específico dele, mas eu gostaria de apresentar como aplicar OTP em forma de Stream cipher e explicar como funciona a camada WEP do procolo 802.11b.</p>

<p>Espero que você tenha tido uma excelente leitura.</p>

<p>Grande abraço e até já! :)</p></p>
                                    <div>
                                        <hr>
                                        <span><i class="pe-7s-date" style="font-weight: bold"></i> Atualizado em 
    out de 2018
</span>
                                    </div>
                                </div>
                                
                                <div class="sharethis-inline-reaction-buttons"></div>
                            </div>
                        </div>
                    </div>
                </article>
            </section>
        </div>

        <div class="articles-info">
            <section class="articles-info-section">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12 col-xs-12">
                            <div class="articles-author">
    <img src="/images/about/avatar.png" class="rounded-circle" alt="Lorival S. Chapuis" data-rjs="2">
    <div class="articles-author-right" style="margin: 0px 0 0 100px;">
        Escrito por:
        <h4>Lorival S. Chapuis</h4>
        
        <p>Engenheiro de software focado em escalabilidade, gamer nas horas de folga, entusiasta em inteligência computacional e apaixonado pela minha família e por desenvolvimento de software.</p>
    </div>
</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="container">
            <div class="row" style="margin-top: 20px;">
                <div class="col-lg-12 col-xs-12">
                    <div id="disqus_thread"></div>
                </div>
            </div>
        </div>
    </main>
</body>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <div class="copyright" style="text-align: center;">
                    <p class="font-primary" style="float: none;">
                        Made and hosted with <i class="fa fa-heart" style="color: #e25555;;"></i> using
                        <a href="https://gohugo.io/" target="_BLANK" class="black">Hugo</a> and <a href="https://pages.github.com/" target="_BLANK" class="black">Github Pages</a>. &copy; 2017-2020</p>
                </div>
            </div>
        </div>
    </div>
</footer>


<script type="text/javascript" src="/js/jquery-1.12.0.min.js"></script>
<script type="text/javascript" src="/js/tether.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/retina.min.js"></script>
<script type="text/javascript" src="/js/owl.carousel.min.js"></script>
<script type="text/javascript" src="/js/webfont.js"></script>


<script type="text/javascript" src="/js/scripts.js"></script>





<script>
    if (window.location.host.indexOf('loriv.al') > -1 && window.location.protocol != "https:"){
        window.location.protocol = "https";
    }
</script>

</body>

</html>